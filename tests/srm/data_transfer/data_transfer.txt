*** Settings ***
Resource   lib/stormlib.txt
Resource   lib/clientSRM.txt
Resource   lib/globus_util.txt
Resource   lib/lcg_util.txt
Resource   lib/dcache.txt
Resource   lib/credentials.txt

*** Test Cases ***

Test that the SRM service is able to transfer a file on the SRM endpoint
  [Tags]  storm-client  globus-utils
  [Setup]  Init certificate and voms proxy  test0  ${VOMSAUTH_SA_VONAME}
  ${filename}  Create local file
  ${surl}  Build surl  ${VOMSAUTH_SA}  ${filename}
  ${output}  ${token}  Perform ptp using clientSRM  ${surl}  -p
  Should Contain  ${output}  SRM_SPACE_AVAILABLE
  Copy-out file using globus-utils  ${filename}  ${VOMSAUTH_SA}  ${filename}
  ${output}  Perform pd using clientSRM  ${surl}  ${token}  -p
  Should Contain  ${output}  SRM_SUCCESS
  ${output}  Perform ls using clientSRM  ${surl}
  Should Contain  ${output}  SRM_SUCCESS
  Perform rm using clientSRM  ${surl}
  Remove local file  ${filename}
  [Teardown]  Clear all credentials

Test that the SRM service is able to transfer a file from the SRM endpoint
  [Tags]  storm-client  ptg
  [Setup]  Init certificate and voms proxy  test0  ${VOMSAUTH_SA_VONAME}
  ${filename}  Create local file
  ${surl}  Build surl  ${VOMSAUTH_SA}  ${filename}
  Copy-out file using lcg-utils  ${filename}  ${surl}
  ${output}  ${token}  Perform ptg using clientSRM  ${surl}  -p -T -P gsiftp
  ${result}  ${turl}=  Should Match Regexp  ${output}  transferURL=(\".+\")
  Copy-in file using gsiftp protocol  ${turl}  ${filename}
  Perform rm using clientSRM  ${surl}
  Remove local file  ${filename}
  [Teardown]  Clear all credentials

Check lcg-cp computed checksum in case it starts with zero
  [Documentation]  Regression test for https://storm.cnaf.infn.it:8443/redmine/issues/108. Given a file with ADLER32 checksum that starts with '0' and a SURL pointing to a non existent file in an existent folder, verify that after transfering the file on the SURL the checksum value computed for the file matches as string with the one of the local file.
  [Tags]  lcg-utils  regression  cp
  [Setup]  Init certificate and voms proxy  test0  ${VOMSAUTH_SA_VONAME}
  ${srcFile}  Create local file with checksum that starts with zero
  ${srcSurl}  Build surl  ${VOMSAUTH_SA}  ${srcFile}
  ${destFile}  Get a unique name
  ${destSurl}  Build surl  ${VOMSAUTH_SA}  ${destFile}
  Copy-out file using lcg-utils  ${srcFile}  ${srcSurl}
  ${output}  Detailed ls using clientSRM  ${srcSurl}
  ${result}  ${b_checksum}=  Should Match Regexp  ${output}  checkSumValue=(\".+\")
  Log  ${b_checksum}
  Copy file using lcg-utils  ${srcSurl}  ${destSurl}
  ${output}  Detailed ls using clientSRM  ${destSurl}
  ${result}  ${a_checksum}=  Should Match Regexp  ${output}  checkSumValue=(\".+\")
  Log  ${a_checksum}
  Should be equal  ${b_checksum}  ${a_checksum}
  Perform rm using clientSRM  ${srcSurl}
  Perform rm using clientSRM  ${destSurl}
  Remove local file  ${srcFile}
  Remove local file  ${destFile}
  [Teardown]  Clear all credentials

Test lcg-cp out
  [Tags]  lcg-utils  cp
  [Setup]  Init certificate and voms proxy  test0  ${VOMSAUTH_SA_VONAME}
  ${filename}  Create local file
  ${surl}  Build surl  ${VOMSAUTH_SA}  ${filename}
  Copy-out file using lcg-utils  ${filename}  ${surl}
  Perform rm using clientSRM  ${surl}
  Remove local file  ${filename}
  [Teardown]  Clear all credentials

Transfer empty file
  [Tags]  regression  ptp  to-be-fixed
  [Documentation]  Regression test for https://storm.cnaf.infn.it:8443/redmine/issues/241. If a client tries to transfer an empty file to a valid gsiftp TURL the transfer fails.
  [Setup]  Init certificate and voms proxy  test0  ${VOMSAUTH_SA_VONAME}
  ${filename}  Create local empty file
  ${surl}  Build surl  ${VOMSAUTH_SA}  ${filename}
  ${output}  ${token}  Perform ptp using clientSRM  ${surl}  -p
  Should Contain  ${output}  SRM_SPACE_AVAILABLE
  ${output}  Try to copy-out file using globus-utils  ${filename}  ${VOMSAUTH_SA}  ${filename}
  Should not contain  ${output}  globus_xio: An end of file occurred
  [Teardown]  Clear all credentials

Copy out a file using lcg-utils
  [Tags]  lcg-utils
  [Setup]  Init certificate and voms proxy  test0  ${VOMSAUTH_SA_VONAME}
  ${filename}  Create local file
  ${surl}  Build surl  ${VOMSAUTH_SA}  ${filename}
  Check file does not exists using lcg-utils  ${surl}
  Copy-out file using lcg-utils  ${filename}  ${surl}
  Copy-in file using lcg-utils  ${surl}  ${filename}_copied
  Execute and check success  diff /tmp/${filename} /tmp/${filename}_copied
  Perform rm using clientSRM  ${surl}
  Remove local file  ${filename}
  Remove local file  ${filename}_copied
  [Teardown]  Clear all credentials

Check checksum of copied file
  [Tags]  lcg-util
  [Documentation]  StoRM BE must be configured with GRIDFTP_WITH_DSI="yes" to pass this test
  [Setup]  Init certificate and voms proxy  test0  ${VOMSAUTH_SA_VONAME}
  ${filename}  Create local file
  ${srcsurl}  Build surl  ${VOMSAUTH_SA}  ${filename}
  ${output}  ${token}  Perform ptp using clientSRM  ${srcsurl}  -p
  Copy-out file using globus-utils  ${filename}  ${VOMSAUTH_SA}  ${filename}
  ${output}  Perform pd using clientSRM  ${srcsurl}  ${token}  -p
  ${destsurl}  Build surl  ${VOMSAUTH_SA}  ${filename}_copied
  ${output}  Copy file using lcg-utils  ${srcsurl}  ${destsurl}  --checksum
  Log  ${output}
  Should Contain  ${output}  Source and destination checksums are matching
  ${output}  Perform rm using clientSRM  ${srcsurl}
  Should Contain  ${output}  SRM_SUCCESS
  ${output}  Perform rm using clientSRM  ${destsurl}
  Should Contain  ${output}  SRM_SUCCESS
  Remove local file  ${filename}
  [Teardown]  Clear all credentials
