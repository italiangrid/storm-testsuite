#!/usr/bin/python

__author__ = 'Elisabetta Ronchieri'

import sys
import unittest
import getopt
from tstorm.utils import reportfile as rf
from tstorm.utils import settings as st
from tstorm.test import commontests as cts
from tstorm.test import basictests as bt
from tstorm.test import basictests_novoms as btnv
from tstorm.test import tapetests as tt
from tstorm.test import regressiontests as rt
from tstorm.test import regression_conftests as rct
from tstorm.test import regression_ldaptests as rlt

methods = {
   'cksm_ts': 'bt.cksm_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'https_ts': 'btnv.https_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'https_voms_ts': 'bt.https_voms_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'cs_ts': 'bt.cs_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'cw_ts': 'bt.cw_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'eight_digit_string_checksum_ts': 'rt.eight_digit_string_checksum_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'non_ascii_chars_ts': 'rt.non_ascii_chars_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'unsupported_protocols_ts': 'rt.unsupported_protocols_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'dt_ts': 'bt.dt_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'http_ts': 'btnv.http_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'glue_info_ts': 'rlt.glue_info_ts(tfn, lfn)',
   'glue_storage_share_capacity_ts': 'rlt.glue_storage_share_capacity_ts(tfn, lfn)',
   'glue_available_space_info_service_ts': 'rlt.glue_available_space_info_service_ts(tfn, lfn)',
   'glue_available_space_ts': 'rlt.glue_available_space_ts(tfn, lfn)',
   'glue_used_space_ts': 'rlt.glue_used_space_ts(tfn, lfn)',
   'size_ts': 'rlt.size_ts(tfn, lfn)',
   'update_used_space_upon_pd_ts': 'rt.update_used_space_upon_pd_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'update_free_space_upon_rm_ts': 'rt.update_free_space_upon_rm_ts(tfn,ifn,dfn,back_ifn, lfn)', 
   'storm_backend_age_ts': 'rt.storm_backend_age_ts(tfn,ifn,dfn,back_ifn, lfn)',
   'conf_ts': 'cts.conf_ts(tfn,ifn,dfn,back_ifn, lfn)',
   'access_tape_ts': 'tt.access_tape_ts(tfn,ifn,dfn,back_ifn, lfn)',
   'backend_server_status_rt': 'rct.backend_server_status_rt(tfn, lfn)',
   'backend_cron_conf_rt': 'rct.backend_cron_conf_rt(tfn, lfn)',
   'backend_logrotate_conf_rt': 'rct.backend_logrotate_conf_rt(tfn, lfn)',
   'backend_gridhttps_rt': 'rct.backend_gridhttps_rt(tfn, lfn)',
   'yaim_version_file_rt': 'rct.yaim_version_file_rt(tfn, lfn)',
   'gridhttps_plugin_links_rt': 'rct.gridhttps_plugin_links_rt(tfn, lfn)',
   'size_in_namespace_file_rt': 'rct.size_in_namespace_file_rt(tfn, lfn)',
   'mysql_connector_java_links_rt': 'rct.mysql_connector_java_links_rt(tfn, lfn)'
}

tests_type = {
   'novoms':['common_tests',
       'basic_tests_novoms',
       'regression_ldaptests'],
   'voms':['common_tests',
       'basic_tests',
       'regression_tests',
       'regression_ldaptests',
       'tape_tests'],
   'conf':['regression_conftests',
       'regression_ldaptests']
}

def run_tests(tpi, lfn, tt, n_df, n_dfn):
   kw='test_plan'
   if tt in tpi[kw]:
     if tt in tpi.keys():
       for y in tpi[tt]:
	 if tt == 'regression_tests' or y in ('https_ts', 'https_voms_ts', 'http_ts'):
	   sd=False
	 else:
	   sd=True
	 if tt != 'regression_conftests':
	   ifn,dfn,back_ifn= st.set_inpt_fn(n_df,n_dfn,subdir=sd)
	 m=methods[y]
         runner = unittest.TextTestRunner(verbosity=2).run(eval(m))

def usage():
    print "Usage: tstorm-tp [-c|--conf] [-d|--destfile] [--novoms] [--conftest]"
    print """Example: if you want to run test without voms"""
    print """         tstorm-tp --novoms"""
    print """Example: if you want to run conf test on a given storm node"""
    print """         tstorm-tp --conftest"""
    print """Example: if you want to run test by changing conf input file and destination filename"""
    print """         tstorm-tp -c etc/tstorm/tstorm.ini -d ui/uo/ua.txt"""

def tpj_details():
    print "Description of tstorm-tp.json.template:"
    print """test_plan - is a key word containing a list of different type of """
    print """            system tests that MUST be specified in the following """
    print """            order of execution, that is """
    print """            ["""
    print """             'common_tests'"""
    print """             'basic_tests'"""
    print """             'regression_tests'"""
    print """             'basic_tests_novoms'"""
    print """             'regression_conftests'"""
    print """             'regression_ldaptests'"""
    print """             'tape_tests'"""
    print """            ]"""
    print """            regression_conftests are executed only if conftest option is used."""
    print """common_tests         - is a key word containing a list of tests that is"""
    print """                       mandatory for all the other tests with the """
    print """                       exclusion of regression conf tests and"""
    print """                       regression ldap tests"""
    print """basic_tests          - is a key word containing a list of tests;"""
    print """regression_tests     - is a key word containing a list of tests;"""
    print """regression_conftests - is a key word containing a list of tests """
    print """                       that MUST run as root;"""
    print """regression_ldaptests - is a key word containing a list of tests;"""
    print """basic_tests_novoms   - is a key word containing a list of tests; """
    print """tape_tests           - is a key word containing a list of tests.\n """
    print "Example of tstorm-tp.json.template:\n"
    st.print_tpj_template('./etc/tstorm/tstorm-tp.json.template')

if __name__ == '__main__':
  tpjfnc= './etc/tstorm/tstorm-tp.json'
  tfn = './etc/tstorm/tstorm.ini'

  try:
    opts, args = getopt.getopt(sys.argv[1:], "hc:d:", ["help","novoms","conftest","conf","destfile"])
  except getopt.GetoptError, err:
    print str(err)
    usage()
    sys.exit(2)

  ct=False
  voms = True
  n_df = False
  n_dfn = ''
  for o, v in opts:
    if o in ("-h", "--help"):
      usage()
      sys.exit()
    elif o in ("-c", "--conf"):
      tfn = v
    elif o in ("-d", "--destfile"):
      n_dfn = v
      n_df = True
    elif o in ("--novoms"):
      voms = False
    elif o in ("--conftest"):
      ct = True
    else:
      assert False, "unhandled option"

  '''Get Test Plan Info from conf file'''
  tpj_info = st.get_tpj_info(tpjfnc)

  if not st.is_valid(tpj_info):
    '''Wrong Test Plan conf file'''
    tpj_details()
    sys.exit(3)

  logf=rf.ReportFile()

  if ct:
    for x in tests_type['conf']:
      run_tests(tpj_info, logf, x, n_df, n_dfn)
  else:
    if voms:
      for x in tests_type['voms']:
        run_tests(tpj_info, logf, x, n_df, n_dfn)
    else:
      '''Basic Tests NO VOMS'''
      for x in tests_type['novoms']:
        run_tests(tpj_info, logf, x, n_df, n_dfn)

  logf.close_file() 

  
