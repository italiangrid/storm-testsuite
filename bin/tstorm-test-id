#!/usr/bin/python

__author__ = 'Elisabetta Ronchieri'

import sys
import os
import getopt
import json
from tstorm.utils import check_testplan as ctp
from tstorm.utils import utils

def usage():
    print "Usage: tstorm-test-id"

if __name__ == '__main__':
    try:
        opts, args = getopt.getopt(sys.argv[1:], "h", ["help"])
    except getopt.GetoptError, err:
        print str(err)
        usage()
        sys.exit(2)

    for o, v in opts:
        if o in ("-h", "--help"):
            usage()
            sys.exit()

    tests_suites = ctp.CheckTestplan().get_test_suites()

    test_id = {}
    for x in tests_suites:
        test_id[x] = utils.get_uuid()

    dirname=os.path.dirname(sys.argv[0])
    configpath = os.path.join(dirname, "../", ".")
    conffile=configpath+'./etc/tstorm/test_id.json'
    sf = open(conffile, 'a')
    sf.write('{\n')
    a=0
    for x in test_id.keys():
        if len(test_id) == a+1:
            sf.write('  "' + x + '":"' + test_id[x] + '"\n')
        else:
            sf.write('  "' + x + '":"' + test_id[x] + '",\n')
        a+=1
    sf.write('}\n')
    sf.close()

    try:
        tp_info=json.read(open(conffile,'r').read())
    except (IOError,json.ReadException):
        #dbglog("No stfunc.conf file found or wrong json syntax")
        print "wrong conf file"
        sys.exit(2)

  
